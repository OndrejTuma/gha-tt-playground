name: Integration tests

on:
  workflow_dispatch:

env:
  # In monorepo if you want to run integration tests only for
  # specific subset of packages, define them in PARALLEL_MATRIX below
  # You can specify how many instances you want to run for package in parallel_groups field
  #  PARALLEL_MATRIX: |
  #    [
  #      {
  #        "pkg": "@toptal/prdik",
  #        "location": "packages/prdik",
  #        "parallel_groups": 2
  #      }
  #    ]
  PARALLEL_GROUPS: 2
  PRINT_COVERAGE: true
  COVERAGE_REPORT_DIR: ./coverage
  COVERAGE_REPORTER: text-summary
  COMMAND: test:integration:ci

  NPM_TOKEN: ${{ secrets.NPM_TOKEN_READ_ONLY }}
  GITHUB_TOKEN: ${{ secrets.TOPTAL_DEVBOT_TOKEN }}

  STATUS_TARGET_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
  STATUS_CHECK_NAME: ${{ github.workflow }}

concurrency:
  group: integration-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create_matrix:
    name: Create:Matrix
    runs-on: ubuntu-latest
    steps:
      - name: Set status check - pending
        uses: actions/github-script@v4
        env:
          STATUS_STATE: pending
        with:
          script: |
            const { owner, repo } = context.issue;
            await github.repos.createCommitStatus({
              owner,
              repo,
              sha: context.sha,
              context: process.env.STATUS_CHECK_NAME,
              state: process.env.STATUS_STATE,
              target_url: process.env.STATUS_TARGET_URL
            })

      - name: Checkout davinci GHAs
        uses: actions/checkout@v2
#        with:
#          repository: toptal/davinci-github-actions
#          token: ${{ env.GITHUB_TOKEN }}
#          path: ./.github/actions/

      - name: Run Matrix
        id: set-matrix
        uses: ./.github/actions/integration-tests-matrix
        with:
          parallel_groups: ${{ env.PARALLEL_GROUPS }}
          parallel_matrix: ${{ env.PARALLEL_MATRIX }}

      - run: echo ${{ fromJSON(steps.set-matrix.outputs.matrix) }}

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      isMonorepo: ${{ steps.set-matrix.outputs.isMonorepo }}

  integration_check:
    name: Check:IntegrationTests
    runs-on: ubuntu-latest
    needs: create_matrix
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.create_matrix.outputs.matrix) }}
    env:
      GROUP_INDEX: ${{ matrix.index }}
      GROUP_LOCATION: ${{ matrix.location }}
      GROUP_PACKAGE: ${{ matrix.pkg }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v2

      - name: Setup node
        uses: actions/setup-node@v2

      - name: Set integration test command
        id: set-command
        run: |
          echo "::set-output name=command::yarn${{ needs.create_matrix.outputs.isMonorepo == 'true' && format(' {0} {1}', 'workspace', env.GROUP_PACKAGE) || ''}} ${{ env.COMMAND }}"

#      - name: Checkout davinci GHAs
#        uses: actions/checkout@v2
#        with:
#          repository: toptal/davinci-github-actions
#          token: ${{ env.GITHUB_TOKEN }}
#          path: ./.github/actions/

      - uses: ./.github/actions/yarn-install
        with:
          npm_token: ${{ env.NPM_TOKEN }}

      - uses: ./.github/actions/integration-tests
        env:
          PARALLEL_GROUPS: ${{ matrix.total || env.PARALLEL_GROUPS }}
        with:
          command: ${{ steps.set-command.outputs.command }}

      - name: Move coverage output to joint folder
        if: ${{ env.PRINT_COVERAGE == 'true' }}
        run: |
          mkdir integration-coverage
          mv $GROUP_LOCATION/$COVERAGE_REPORT_DIR/coverage-final.json integration-coverage/coverage.${GROUP_PACKAGE////-}.$GROUP_INDEX.json

      - name: Upload Coverage
        if: ${{ env.PRINT_COVERAGE == 'true' }}
        uses: actions/upload-artifact@v2
        with:
          name: integration-coverage
          path: integration-coverage

  coverage_report:
    name: Report:Coverage
    runs-on: ubuntu-latest
    needs: integration_check
    steps:
      - name: Checkout davinci GHAs
        uses: actions/checkout@v2
#        with:
#          repository: toptal/davinci-github-actions
#          token: ${{ env.GITHUB_TOKEN }}
#          path: ./.github/actions/

      - name: Print Coverage
        if: ${{ env.PRINT_COVERAGE == 'true' }}
        uses: ./.github/actions/report-coverage
        with:
          name: integration-coverage

      - name: Set status check - success / error
        uses: actions/github-script@v4
        env:
          STATUS_STATE: ${{ needs.integration_check.result == 'success' && 'success' || 'error' }}
        with:
          script: |
            const { owner, repo } = context.issue;
            await github.repos.createCommitStatus({
              owner,
              repo,
              sha: context.sha,
              context: process.env.STATUS_CHECK_NAME,
              state: process.env.STATUS_STATE,
              target_url: process.env.STATUS_TARGET_URL
            })
